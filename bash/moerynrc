if [ "$TERM" != "dumb" ]; then
    eval `dircolors -b`
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# Useful options
if type llvm-symbolizer &> /dev/null; then
    export ASAN_SYMBOLIZER_PATH="$(which llvm-symbolizer)"
fi
export ASAN_OPTIONS=abort_on_error=1:detect_leaks=1
export LSAN_OPTIONS=use_stacks=0:use_registers=0:use_globals=1:use_tls=1
export HISTSIZE=10000

# Enable all cores generation
ulimit -c unlimited

# Disable Caps lock to Escape
xmodmap -e 'clear Lock' -e 'keycode 0x42 = Escape'

# Find a random bug in a test suite
function randbug()
{
    local i=0
    local filepath="/tmp/randbug"

    echo -e "starting rand bug procedure"
    while true; do
        local start_timer=$(date +%s.%N)
        local duration=""

        i=$((i+1))

        $@ &> $filepath
        if [ $? -ne 0 ]; then
            cat $filepath
            echo -e "bug found during the $i execution"
            echo -e "bug report dump in $filepath"
            break
        fi

        duration=`echo "($(date +%s.%N) - $start_timer)*1000" | bc \
                | awk '{printf "%.2f\n", $0}'`
        echo -e "Execution: $i elapsed: $duration  ms"
    done
}

# Build FlameGraph
function flameit()
{
    local filename=""

    if [ -z $1 ]; then
        filename="flamegraph"
    elif [[ "$1" == "-h" ]]; then
        echo -e "FlameGraph helper"
        echo -e "-----------------"
        echo -e "usage: flameit [filename prefix] | [-h]"
        return
    else
        filename=$1
    fi

    filename+="-`date +'%d%m-%H%M%S'`.svg"

    echo -e "generating flamegraph $filename..."

    perf script | ~/CONFIG/tools/FlameGraph/stackcollapse-perf.pl \
                | ~/CONFIG/tools/FlameGraph/flamegraph.pl         \
                > $filename

    if [ $? -ne 0 ]; then
        return
    fi

    echo -e "generation done."
    while true; do
        if [[ $ZSH_NAME == "zsh" ]]; then
            read "yn?Open in google-chrome the flame graph? y/n"
        else
            read -p "Open in google-chrome the flame graph? y/n" yn
        fi
        case $yn in
            [Yy]* ) google-chrome $filename; break;;
            [Nn]* ) return;;
            * ) echo "Please answer y or n.";;
        esac
    done
}

if [[ $ZSH_NAME != "zsh" ]]; then
    export -f flameit
    export -f randbug
fi

# {{{ Aliases

# Remove all swp and swo files recursively
alias vimclean='find . -name ".*.swp" -type f -delete; find . -name ".*.swo" -type f -delete; find . -name ".*.swn" -type f -delete'
alias ls=' ls --color=auto'
alias myls=' ls -C -F -h --color=always'
alias l=" myls -l"
alias ll=' myls -l'
alias la=' myls -lA'
alias v=" clear; ll -gh"    # standard directory view
alias vs=" v **/*(.)"       # show all files in all subdirs plain in a list

# }}}

# vim: syn=sh
